{% extends "base.html" %}
{% block title %}Analisis Data{% endblock %}
{% block content %}

<div class="max-w-7xl mx-auto px-6 py-12">
  <h1 class="text-3xl font-bold mb-2">Analisis Data</h1>
  <p class="text-gray-600 mb-8">
    Dashboard analitik dengan visualisasi hubungan antar parameter polutan dan meteorologi
  </p>

  âœ… Insight Cards
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5 mb-10">
    {% for c in cards %}
    <div
      class="p-5 rounded-xl border {% if c.value|slice:':1' == '-' %}border-green-200 bg-green-50{% else %}border-yellow-200 bg-yellow-50{% endif %}">
      <div class="flex justify-between items-start">
        <div>
          <h4 class="font-semibold">{{ c.title }}</h4>
          <p class="text-sm text-gray-600 mt-1">{{ c.desc }}</p>
        </div>
        <span class="text-2xl font-bold">{{ c.value }}</span>
      </div>
    </div>
    {% endfor %}
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-10">
    <div class="p-6 bg-white rounded-xl shadow border">
      <h2 class="font-semibold text-lg mb-3">Korelasi Suhu vs PM2.5</h2>
      <canvas id="scatterChart" height="250"></canvas>
      <div class="mt-4 bg-blue-50 text-blue-800 text-sm p-3 rounded-lg">
        Korelasi: <b>+0.72</b> â€” Terdapat hubungan positif kuat antara suhu dan konsentrasi PM2.5
      </div>
    </div>

    <div class="p-6 bg-white rounded-xl shadow border mb-10 relative">
      <h2 class="font-semibold text-lg mb-3">Konsentrasi Polutan vs Batas Aman</h2>

      <div class="absolute top-5 right-5">
        <select id="stationSelector"
          class="border border-gray-300 rounded-md bg-white text-sm px-3 py-1.5 shadow-sm focus:ring-2 focus:ring-blue-400">
          <option value="avg">Rata-rata Semua Stasiun</option>
        </select>
      </div>

      <div class="relative overflow-x-auto">
        <canvas id="barChartMain" class="w-full h-[380px]"></canvas>
      </div>

      <p class="text-xs text-gray-500 mt-2">
        Perbandingan konsentrasi aktual terhadap batas aman WHO untuk masing-masing parameter polutan.
      </p>
    </div>

  </div>

  <div class="p-6 bg-white rounded-xl shadow border mb-10">
    <h2 class="font-semibold text-lg mb-5">Matriks Korelasi Parameter (Spearman)</h2>
    <p class="text-sm text-gray-600 mb-4">
      Warna menunjukkan kekuatan dan arah hubungan antara parameter polutan dan meteorologi.
    </p>

    <canvas id="heatmapChart" height="350" style="max-height: 400px; width: 100%;"></canvas>

    <div class="mt-5 text-xs text-gray-600">
      <p><b>Keterangan warna:</b> ðŸ”´ Positif kuat &nbsp;&nbsp; âšª Lemah / Tidak ada &nbsp;&nbsp; ðŸ”µ Negatif kuat</p>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@1.2.0/dist/chartjs-chart-matrix.min.js"></script>

{{ bar_labels|json_script:"labels-data" }}
{{ bar_actual|json_script:"actual-data" }}
{{ bar_who|json_script:"who-data" }}
{{ heatmap_data|json_script:"heatmap-data" }}
{{ scatter_data|json_script:"scatter-data" }}
{{ scatter_corr|json_script:"scatter-corr" }}


<script>
  const labels = JSON.parse(document.getElementById('labels-data').textContent);
  const actual = JSON.parse(document.getElementById('actual-data').textContent);
  const who = JSON.parse(document.getElementById('who-data').textContent);

  new Chart(document.getElementById('scatterChart'), {
    type: 'scatter',
    data: {
      datasets: [{
        data: [{ x: 10, y: 20 }, { x: 15, y: 30 }, { x: 20, y: 45 }, { x: 25, y: 60 }, { x: 30, y: 80 }, { x: 35, y: 95 }],
        backgroundColor: '#2563eb'
      }]
    },
    options: {
      plugins: { legend: { display: false } },
      scales: {
        x: { title: { display: true, text: 'Suhu (Â°C)' } },
        y: { title: { display: true, text: 'PM2.5 (Âµg/mÂ³)' } }
      }
    }
  });


  const labelsBar = JSON.parse(document.getElementById('labels-data').textContent);
  const actualData = JSON.parse(document.getElementById('actual-data').textContent);
  const limitData = JSON.parse(document.getElementById('who-data').textContent);

  const ctxBar = document.getElementById('barChartMain');
  new Chart(ctxBar, {
    type: 'bar',
    data: {
      labels: labelsBar,
      datasets: [
        {
          label: 'Konsentrasi Hari Ini',
          data: actualData,
          backgroundColor: '#3b82f6',
          borderRadius: 6
        },
        {
          label: 'Batas Aman WHO',
          data: limitData,
          backgroundColor: '#a7f3d0',
          borderRadius: 6
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: { beginAtZero: true, title: { display: true, text: 'Konsentrasi (Âµg/mÂ³)' } },
        x: { title: { display: true, text: 'Parameter Polutan' } }
      },
      plugins: {
        legend: { position: 'bottom' }
      }
    }
  });


  // === Dropdown listener untuk ganti data ===
  document.getElementById('stationSelector').addEventListener('change', e => {
    const val = e.target.value;
    barChart.data.datasets[0].data =
      val === 'avg' ? getAvgData() : Object.values(stationData[val]);
    barChart.data.datasets[0].label =
      val === 'avg' ? 'Rata-rata Semua Stasiun' : `Konsentrasi di ${val}`;
    barChart.update();
  });


  // === Heatmap ===
  const ctx = document.getElementById('heatmapChart').getContext('2d');
  const matrixData = JSON.parse(document.getElementById('heatmap-data').textContent);

  // Ambil label unik
  const meteos = ["TN", "TX", "TAVG", "RH_AVG", "RR", "FF_X"];
  const polutans = ["pm10", "pm25", "so2", "co", "o3", "no2"];

  // Format data jadi grid numerik
  const formattedData = [];
  polutans.forEach((pol, i) => {
    meteos.forEach((met, j) => {
      const found = matrixData.find(d => d.x === met && d.y === pol);
      formattedData.push({
        x: j,
        y: i,
        v: found ? found.v : 0,
        xLabel: met,
        yLabel: pol
      });
    });
  });

  // Buat chart matrix
  new Chart(ctx, {
    type: 'matrix',
    data: {
      datasets: [{
        data: formattedData,
        borderWidth: 1,
        borderColor: 'rgba(255,255,255,0.6)',
        backgroundColor(ctx) {
          const v = ctx.raw.v;
          const t = (v + 1) / 2; // normalisasi -1..1 ke 0..1
          const r = t < 0.5 ? Math.round(2 * t * 255) : 255;
          const g = t < 0.5 ? Math.round(2 * t * 255) : Math.round(255 * (1 - 2 * (t - 0.5)));
          const b = t < 0.5 ? 255 : Math.round(255 * (1 - 2 * (t - 0.5)));
          return `rgba(${r}, ${g}, ${b}, 0.9)`;
        },
        width: ctx => ctx.chart.chartArea
          ? (ctx.chart.chartArea.width / meteos.length) * 0.9
          : 0,
        height: ctx => ctx.chart.chartArea
          ? (ctx.chart.chartArea.height / polutans.length) * 0.9
          : 0,
      }]
    },
    options: {
      maintainAspectRatio: false,
      layout: { padding: { top: 30, left: 50, right: 20, bottom: 10 } },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            title: items => `${items[0].raw.yLabel} Ã— ${items[0].raw.xLabel}`,
            label: item => `r = ${item.raw.v.toFixed(2)}`
          }
        },
      },
      scales: {
        x: {
          type: 'linear',
          position: 'top',
          min: -0.5,
          max: meteos.length - 0.5,
          ticks: { display: false },
          grid: { display: false }
        },
        y: {
          type: 'linear',
          reverse: true,
          min: -0.5,
          max: polutans.length - 0.5,
          ticks: { display: false },
          grid: { display: false }
        }
      }
    },
    plugins: [{
      id: 'label-centering',
      afterDraw(chart) {
        const ctx = chart.ctx;
        const { x, y } = chart.scales;
        ctx.save();
        ctx.font = 'bold 12px sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillStyle = '#222';

        // ====== Label X (meteorologi) ======
        meteos.forEach((label, i) => {
          const xPos = x.getPixelForValue(i);
          const yPos = x.top - 10;
          ctx.fillText(label, xPos, yPos);
        });

        // ====== Label Y (polutan) ======
        polutans.forEach((label, j) => {
          const xPos = x.left - 25;
          const yPos = y.getPixelForValue(j);
          ctx.fillText(label, xPos, yPos);
        });

        // ====== Nilai r di tengah kotak ======
        chart.data.datasets[0].data.forEach(point => {
          const xPos = x.getPixelForValue(point.x);
          const yPos = y.getPixelForValue(point.y);
          ctx.fillStyle = '#111';
          ctx.fillText(point.v.toFixed(4), xPos, yPos);
        });

        ctx.restore();
      }
    }]
  });
</script>

{% endblock %}